#!/bin/sh
# =========================================
# configure
#
# Hamid R. Bazoobandi
# Sat 14.7.2012 Amsterdam
# =========================================
compiler="none"
gcc="no"
clang="no"
output=config.mak
loader="loader.bin"
kernel="kernel.bin"
init="init"
usrlib="libos.a"
image_name="vuos.iso"
# =========================================
# Check options
for opt do
  optarg=`expr "x$opt" : 'x[^=]*=\(.*\)'`
  case $opt in
  --help|-h) show_help="yes"
  ;;
  --kernel-name=*) 
    if test "$optarg" = ""; then
      echo "Kernel name can not be empty string!";
      exit 1;
    fi
    kernel="$optarg"
  ;;
  --loader-name=*)
    if test "$optarg" = ""; then
      echo "Loader name can not be empty string!";
      exit 1;
    fi
    loader="$optarg";
  ;;
  --init-name=*)
    if test "$optarg" = ""; then
      echo "init name can not be empty string!";
      exit 1;
    fi
    init="$optarg";
  ;;
 --image-name=*)
    if test "$optarg" = ""; then
      echo "image name can not be empty string!";
      exit 1;
    fi
    image_name="$optarg";
  ;;
  --usrlib-name=*)
    if test "$optarg" = ""; then
      echo "init name can not be empty string!";
      exit 1;
    fi
    usrlib="$optarg";
  ;;

  *) echo "ERROR: Unknown option $opt"; show_help="yes"
  ;;
  esac
done
# =========================================
if test "$show_help" = "yes"; then
  echo "Usage: configure [options]"
  echo
  echo "Options:"
  echo "--help              Print this message"
  echo "--kernel-name       Change default kernel name. Default kernel name is \"kernel.bin\"."
  echo "--loader-name       Change default loader name. Default loader name is \"loader.bin\"."
  echo "--init-name         Change default init name. Default init name is \"init\"."
  echo "--image-name        Change default image name. Default init name is \"vuos.iso\"."
  echo "--usrlib-name       Change default user lib name. Default user lib name is \"libos.a\"."
  exit 1;
fi
# =========================================
echo -n "Checking genisoimage "
if ! type "genisoimage" >/dev/null 2>&1; then
  echo "ERROR: genisoimage not found!" >&2;
  exit 1
fi
echo "OK!"
# =========================================
#echo -n "Checking grub... "
#if ! type "grub" >/dev/null 2>&1; then
#  echo "ERROR: grub not found!" >&2;
#  exit 1
#fi
#echo "OK!"
# =========================================
echo "Checking compilers... "

if type "gcc" >/dev/null 2>&1; then
  gcc="yes"
fi
if type "clang" >/dev/null 2>&1; then
  clang="yes"
fi

if test "$gcc" = "yes" && test "$clang" = "yes"; then
  echo "Both \"gcc\" and \"clang\" were found installed on your system."
  echo -n "Which one do you prefer to use to compile the code?[GCC/clang] "
  while read ans; do
    case $ans in
      ""|gcc) 
        compiler="gcc"
        break;
      ;;
      clang)
        compiler="clang"
        break;
      ;;
      *)
        echo "Invalid data! Please enter either \"gcc\" or \"clang\"!";
        echo -n "Which one do you prefer to use to compile the code?[GCC/clang] "
      ;;
    esac
 done 
fi

if test "$compiler" = "none"; then
  if test "$gcc" = "yes"; then
    compiler="gcc";
  else 
    if test "$clang" = "yes"; then
      compiler="clang"
    else
      echo "ERROR: No compiler found!" >&2;
      exit 1;
    fi
  fi
fi

echo "Checking compilers... OK! "

echo -n "Generating config.mak... "
echo "# This file is automatically generated! Don't edit!" > $output
echo "export LOADER     = $loader"     >> $output
echo "export KERNEL     = $kernel"     >> $output
echo "export IMAGE      = $image_name" >> $output
echo "export USRLIB     = $usrlib"     >> $output
echo "export INIT       = $init"       >> $output
echo "export CC         = $compiler"   >> $output
echo "export CONFIG-MAK = $output"     >> $output
echo "OK!"

echo "Configuration completed successfully!"
